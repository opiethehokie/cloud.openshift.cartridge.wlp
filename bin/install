#!/bin/bash -e

source $OPENSHIFT_CARTRIDGE_SDK_BASH

client_message "liberty install"

core_jar=wlp-beta-runtime-2014.3.0.0.jar
extended_jar=wlp-beta-extended-2014.3.0.0.jar

#TODO need to cache these somehow
if [ ! -d $OPENSHIFT_LIBERTY_DIR/wlp ]; then
  #wget https://public.dhe.ibm.com/ibmdl/export/pub/software/websphere/wasdev/downloads/wlp/beta/$core_jar -O $OPENSHIFT_TMP_DIR/$core_jar
  #wget https://public.dhe.ibm.com/ibmdl/export/pub/software/websphere/wasdev/downloads/wlp/beta/$extended_jar -O $OPENSHIFT_TMP_DIR/$extended_jar
  #java -jar $OPENSHIFT_TMP_DIR/$core_jar --acceptLicense $OPENSHIFT_LIBERTY_DIR
  #java -jar $OPENSHIFT_TMP_DIR/$extended_jar --acceptLicense $OPENSHIFT_LIBERTY_DIR
  java -jar $OPENSHIFT_LIBERTY_DIR/bin/$core_jar --acceptLicense $OPENSHIFT_LIBERTY_DIR
fi

cp -r $OPENSHIFT_LIBERTY_DIR/template/servers $OPENSHIFT_LIBERTY_DIR/wlp/usr/

mkdir -p $OPENSHIFT_LIBERTY_DIR/wlp/usr/servers/defaultServer/apps

pushd $OPENSHIFT_LIBERTY_DIR/template/project/src/main/webapp 1> /dev/null
  jar cvf ${OPENSHIFT_LIBERTY_DIR}/wlp/usr/servers/defaultServer/apps/ROOT.war ./*
popd 1> /dev/null

echo "host=$OPENSHIFT_LIBERTY_IP" >> $OPENSHIFT_LIBERTY_DIR/wlp/usr/servers/defaultServer/bootstrap.properties
echo "http.port=$OPENSHIFT_LIBERTY_PORT" >> $OPENSHIFT_LIBERTY_DIR/wlp/usr/servers/defaultServer/bootstrap.properties

